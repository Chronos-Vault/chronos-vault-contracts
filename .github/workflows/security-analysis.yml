name: Trinity v3.5.1 Security Analysis

on:
  push:
    branches: [ main ]
    paths:
      - 'ethereum/**/*.sol'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenZeppelin contracts
        working-directory: ethereum
        run: npm install @openzeppelin/contracts@^5.0.0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Slither
        run: |
          pip install slither-analyzer
          pip install solc-select
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Run Slither with via-IR
        working-directory: ethereum
        run: |
          slither TrinityConsensusVerifier.sol \
            --json slither-report.json \
            --solc-args="--via-ir --optimize --optimize-runs 200" \
            --solc-remaps "@openzeppelin=node_modules/@openzeppelin" \
            --exclude naming-convention,solc-version,unused-state,timestamp \
            --filter-paths "openzeppelin" || true

      - name: Upload Slither Report
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: ethereum/slither-report.json

      - name: Analyze Slither Results
        working-directory: ethereum
        run: |
          if [ -f slither-report.json ]; then
            echo "üìä Slither Analysis Results:"
            
            HIGH_COUNT=$(jq '[.results.detectors[] | select(.impact == "High")] | length' slither-report.json 2>/dev/null || echo "0")
            CRITICAL_COUNT=$(jq '[.results.detectors[] | select(.impact == "Critical")] | length' slither-report.json 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(jq '[.results.detectors[] | select(.impact == "Medium")] | length' slither-report.json 2>/dev/null || echo "0")
            LOW_COUNT=$(jq '[.results.detectors[] | select(.impact == "Low")] | length' slither-report.json 2>/dev/null || echo "0")
            
            echo "   CRITICAL: $CRITICAL_COUNT"
            echo "   HIGH: $HIGH_COUNT"
            echo "   MEDIUM: $MEDIUM_COUNT"
            echo "   LOW: $LOW_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo ""
              echo "‚ùå FAILED: Found CRITICAL or HIGH severity vulnerabilities!"
              echo ""
              jq '.results.detectors[] | select(.impact == "High" or .impact == "Critical") | {impact: .impact, check: .check, description: .description}' slither-report.json
              exit 1
            else
              echo ""
              echo "‚úÖ PASSED: No CRITICAL or HIGH severity issues found"
              echo "üìã Review MEDIUM/LOW issues manually in artifact"
            fi
          else
            echo "‚ö†Ô∏è  slither-report.json not found - Slither failed to run"
            exit 1
          fi

  compilation-test:
    name: Solidity Compilation with via-IR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenZeppelin
        working-directory: ethereum
        run: npm install @openzeppelin/contracts@^5.0.0

      - name: Install solc
        run: |
          pip install solc-select
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Compile with via-IR
        working-directory: ethereum
        run: |
          echo "üî® Compiling Trinity v3.5.1 with via-IR..."
          
          solc @openzeppelin=node_modules/@openzeppelin \
            --via-ir \
            --optimize --optimize-runs 200 \
            --bin --abi --hashes \
            --overwrite --output-dir ./build \
            TrinityConsensusVerifier.sol \
            libraries/*.sol
          
          echo "‚úÖ Compilation successful with via-IR!"
          
          # Check contract size
          if [ -f build/TrinityConsensusVerifier.bin ]; then
            SIZE=$(cat build/TrinityConsensusVerifier.bin | wc -c)
            SIZE=$((SIZE / 2))
            PERCENT=$((SIZE * 100 / 24576))
            
            echo ""
            echo "üì¶ Contract Size Analysis:"
            echo "   Bytecode: $SIZE bytes"
            echo "   Limit: 24,576 bytes"
            echo "   Usage: $PERCENT%"
            
            if [ $SIZE -gt 24576 ]; then
              echo ""
              echo "‚ùå ERROR: Contract exceeds 24KB Ethereum size limit!"
              exit 1
            else
              echo ""
              echo "‚úÖ Contract size within limits"
            fi
          else
            echo "‚ùå Compilation artifact not found"
            exit 1
          fi

name: Security Analysis & Testing

on:
  push:
    branches: [ main ]
    paths:
      - 'ethereum/**/*.sol'
      - 'ethereum/test/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Slither
        run: |
          pip install slither-analyzer
          pip install solc-select
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Run Slither on TrinityConsensusVerifier
        working-directory: ethereum
        run: |
          slither TrinityConsensusVerifier.sol \
            --json slither-report.json \
            --checkers-to-exclude naming-convention,solc-version \
            --filter-paths "openzeppelin" || true

      - name: Upload Slither Report
        uses: actions/upload-artifact@v3
        with:
          name: slither-report
          path: ethereum/slither-report.json

      - name: Check for HIGH/CRITICAL issues
        working-directory: ethereum
        run: |
          if [ -f slither-report.json ]; then
            HIGH_COUNT=$(jq '[.results.detectors[] | select(.impact == "High")] | length' slither-report.json)
            CRITICAL_COUNT=$(jq '[.results.detectors[] | select(.impact == "Critical")] | length' slither-report.json)
            
            echo "üîç Slither Analysis Results:"
            echo "   HIGH issues: $HIGH_COUNT"
            echo "   CRITICAL issues: $CRITICAL_COUNT"
            
            if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "‚ùå FAILED: Found HIGH or CRITICAL security issues!"
              exit 1
            else
              echo "‚úÖ PASSED: No HIGH or CRITICAL issues found"
            fi
          fi

  hardhat-tests:
    name: Hardhat Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        working-directory: ethereum
        run: |
          npm install --save-dev \
            hardhat \
            @nomicfoundation/hardhat-toolbox \
            @nomicfoundation/hardhat-verify \
            @nomicfoundation/hardhat-ethers \
            @nomicfoundation/hardhat-chai-matchers \
            @typechain/hardhat \
            @typechain/ethers-v6 \
            ethers \
            chai \
            typescript \
            @types/node \
            @types/mocha \
            @types/chai

      - name: Compile contracts
        working-directory: ethereum
        run: npx hardhat compile

      - name: Run tests
        working-directory: ethereum
        run: npx hardhat test

      - name: Check contract size
        working-directory: ethereum
        run: |
          SIZE=$(cat artifacts/contracts/TrinityConsensusVerifier.sol/TrinityConsensusVerifier.json | jq -r '.deployedBytecode' | wc -c)
          SIZE=$((SIZE / 2 - 1))
          PERCENT=$((SIZE * 100 / 24576))
          
          echo "üì¶ Contract Size: $SIZE bytes ($PERCENT% of 24KB limit)"
          
          if [ $SIZE -gt 24576 ]; then
            echo "‚ùå FAILED: Contract exceeds 24KB limit!"
            exit 1
          else
            echo "‚úÖ PASSED: Contract size OK"
          fi

  compilation-check:
    name: Compilation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Hardhat
        working-directory: ethereum
        run: npm install --save-dev hardhat

      - name: Compile all contracts
        working-directory: ethereum
        run: npx hardhat compile

      - name: Verify compilation artifacts
        working-directory: ethereum
        run: |
          if [ ! -f "artifacts/contracts/TrinityConsensusVerifier.sol/TrinityConsensusVerifier.json" ]; then
            echo "‚ùå Main contract failed to compile"
            exit 1
          fi
          
          for lib in Errors ProofValidation FeeAccounting ConsensusProposalLib OperationLifecycle; do
            if [ ! -f "artifacts/contracts/libraries/${lib}.sol/${lib}.json" ]; then
              echo "‚ùå Library ${lib} failed to compile"
              exit 1
            fi
          done
          
          echo "‚úÖ All contracts and libraries compiled successfully"

name: Trinity v3.5.1 Security Analysis

on:
  push:
    branches: [ main ]
    paths:
      - 'ethereum/**/*.sol'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenZeppelin contracts
        working-directory: ethereum
        run: |
          mkdir -p node_modules/@openzeppelin
          npm install @openzeppelin/contracts@^5.0.0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Slither
        run: |
          pip install slither-analyzer
          pip install solc-select
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Run Slither on Trinity v3.5.1
        working-directory: ethereum
        run: |
          slither TrinityConsensusVerifier.sol \
            --json slither-report.json \
            --solc-remaps "@openzeppelin=node_modules/@openzeppelin" \
            --exclude naming-convention,solc-version,unused-state,timestamp \
            --filter-paths "openzeppelin" || true

      - name: Upload Slither Report
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: ethereum/slither-report.json

      - name: Check for HIGH/CRITICAL issues
        working-directory: ethereum
        run: |
          if [ -f slither-report.json ]; then
            echo "üìä Slither Analysis Results:"
            
            HIGH_COUNT=$(jq '[.results.detectors[] | select(.impact == "High")] | length' slither-report.json 2>/dev/null || echo "0")
            CRITICAL_COUNT=$(jq '[.results.detectors[] | select(.impact == "Critical")] | length' slither-report.json 2>/dev/null || echo "0")
            MEDIUM_COUNT=$(jq '[.results.detectors[] | select(.impact == "Medium")] | length' slither-report.json 2>/dev/null || echo "0")
            
            echo "   CRITICAL issues: $CRITICAL_COUNT"
            echo "   HIGH issues: $HIGH_COUNT"
            echo "   MEDIUM issues: $MEDIUM_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "‚ùå FAILED: Found CRITICAL or HIGH severity issues"
              jq '.results.detectors[] | select(.impact == "High" or .impact == "Critical")' slither-report.json
              exit 1
            else
              echo "‚úÖ PASSED: No CRITICAL or HIGH severity issues found"
            fi
          else
            echo "‚ö†Ô∏è  WARNING: slither-report.json not found"
            exit 1
          fi

  solidity-compile-check:
    name: Solidity Compilation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenZeppelin
        working-directory: ethereum
        run: npm install @openzeppelin/contracts@^5.0.0

      - name: Install solc
        run: |
          pip install solc-select
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Compile Trinity v3.5.1
        working-directory: ethereum
        run: |
          solc @openzeppelin=node_modules/@openzeppelin \
            --optimize --optimize-runs 200 \
            --bin --abi --hashes \
            --overwrite --output-dir ./build \
            TrinityConsensusVerifier.sol \
            libraries/*.sol
          
          echo "‚úÖ Compilation successful"
          
          # Check contract size
          if [ -f build/TrinityConsensusVerifier.bin ]; then
            SIZE=$(cat build/TrinityConsensusVerifier.bin | wc -c)
            SIZE=$((SIZE / 2))
            PERCENT=$((SIZE * 100 / 24576))
            
            echo "üì¶ Contract Size: $SIZE bytes ($PERCENT% of 24KB limit)"
            
            if [ $SIZE -gt 24576 ]; then
              echo "‚ùå Contract exceeds 24KB size limit!"
              exit 1
            fi
          fi

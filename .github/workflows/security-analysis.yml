name: Security Analysis & Testing

on:
  push:
    branches: [ main ]
    paths:
      - 'ethereum/**/*.sol'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ethereum
        run: npm install

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Slither
        run: |
          pip install slither-analyzer
          pip install solc-select
          solc-select install 0.8.20
          solc-select use 0.8.20

      - name: Run Slither
        working-directory: ethereum
        run: |
          slither TrinityConsensusVerifier.sol \
            --json slither-report.json \
            --exclude naming-convention,solc-version \
            --filter-paths "openzeppelin" \
            --solc-remaps "@openzeppelin=node_modules/@openzeppelin" || true

      - name: Upload Slither Report
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: ethereum/slither-report.json

      - name: Check Results
        working-directory: ethereum
        run: |
          if [ -f slither-report.json ]; then
            cat slither-report.json | jq '.results.detectors[] | select(.impact == "High" or .impact == "Critical")'
            HIGH_COUNT=$(jq '[.results.detectors[] | select(.impact == "High")] | length' slither-report.json)
            CRITICAL_COUNT=$(jq '[.results.detectors[] | select(.impact == "Critical")] | length' slither-report.json)
            
            echo "HIGH: $HIGH_COUNT, CRITICAL: $CRITICAL_COUNT"
            
            if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
              exit 1
            fi
          fi

  compilation-check:
    name: Compilation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ethereum
        run: npm install

      - name: Compile contracts
        working-directory: ethereum
        run: npx hardhat compile

      - name: Check artifacts
        working-directory: ethereum
        run: |
          if [ ! -f "artifacts/contracts/TrinityConsensusVerifier.sol/TrinityConsensusVerifier.json" ]; then
            echo "❌ Main contract failed"
            exit 1
          fi
          echo "✅ Compilation successful"

      - name: Check contract size
        working-directory: ethereum
        run: |
          SIZE=$(cat artifacts/contracts/TrinityConsensusVerifier.sol/TrinityConsensusVerifier.json | jq -r '.deployedBytecode' | wc -c)
          SIZE=$((SIZE / 2 - 1))
          PERCENT=$((SIZE * 100 / 24576))
          echo "Contract: $SIZE bytes ($PERCENT% of 24KB)"
          if [ $SIZE -gt 24576 ]; then
            exit 1
          fi
